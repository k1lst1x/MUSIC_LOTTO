{% extends 'base.html' %}
{% load static %}

{% block links %}
    <link rel="stylesheet" href="{% static 'css/music_lotto_detail.css' %}">
{% endblock %}

{% block content %}
    <style>
        body {
            transform: scale(0.8);
            transform-origin: top; /* –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –ª–µ–≤–æ–≥–æ —É–≥–ª–∞ */
            overflow: hidden;
        }
    </style>
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- <h1 class="text-center">{{ music_lotto.name }}</h1>
    <p class="text-center"><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {{ music_lotto.created_at|date:"d M Y H:i" }}</p>
    <p class="text-center"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:</strong> {{ music_lotto.edited_at|date:"d M Y H:i" }}</p>
    <p class="text-center"><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ music_lotto.is_active|yesno:"–ê–∫—Ç–∏–≤–Ω–æ,–ù–µ–∞–∫—Ç–∏–≤–Ω–æ" }}</p> -->
    <div class="login-logo text-center">
        <h1>
            <a href="{% url 'home' %}" class="text-decoration-none">
                <picture>
                    <source srcset="/static/MUSIC_LOTTO.png" media="(prefers-color-scheme: dark)">
                    <img src="/static/MUSIC_LOTTO.png" alt="MUSIC LOTTO –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" class="img-fluid">
                </picture>
            </a>
        </h1>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è) -->
            <div class="col-md-3">
                <div class="d-flex flex-column gap-3">
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="generate" class="btn w-100">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    </form>

                    <form method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="ticket_count" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤:</label>
                            <input type="number" name="ticket_count" id="ticket_count" class="form-control" value="{{ default_ticket_count }}" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="round_number" class="form-label">–ù–æ–º–µ—Ä —Ä–∞—É–Ω–¥–∞:</label>
                            <input type="number" name="round_number" id="round_number" class="form-control" value="{{ default_round_number }}" min="1" required>
                        </div>
                        <button type="submit" name="create_tickets" class="btn w-100">–°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç—ã</button>
                    </form>

                    {% if tickets_pdf_exists %}
                        <a href="{{ tickets_pdf_url }}" class="btn w-100" download>–°–∫–∞—á–∞—Ç—å –±–∏–ª–µ—Ç—ã</a>
                    {% else %}
                        <button class="btn btn-secondary w-100" disabled>PDF –±–∏–ª–µ—Ç—ã –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤—ã</button>
                    {% endif %}

                    <!-- <form target="_blank" method="post" action="{% url 'music_lotto_tracks' music_lotto.id %}">
                        {% csrf_token %}
                        <button type="submit" name="show_tracks" class="btn w-100">–í—ã–≤–æ–¥ —Ç—Ä–µ–∫–æ–≤</button>
                    </form> -->

                    <form action="{% url 'music_lotto_list' %}" method="get">
                        <button type="submit" class="btn w-100">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</button>
                    </form>
                </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ (–¢–∞–±–ª–∏—Ü–∞ —Å —Ç—Ä–µ–∫–∞–º–∏) -->
            <!-- <div class="col-md-6">
                <div class="scrollable-table-container">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in music_lotto.playlist_files.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ file.file.name }}</td>
                                    <td><a href="{{ file.file.url }}" class="btn btn-sm" download>–°–∫–∞—á–∞—Ç—å</a></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">–¢—Ä–µ–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div> -->
            <div class="col-md-6">
                <div class="track-status py-4 px-2">
            
                    <h2 class="h2 text-center fw-bold mb-4">üéß –°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</h2>
                    <p class="display-6 text-center mb-5" id="current-track">&mdash;</p>
            
                    <h3 class="h2 fw-bold mb-3 text-center">–ü–æ—Å–ª–µ–¥–Ω–∏–µ‚ÄØ10‚ÄØ—Ç—Ä–µ–∫–æ–≤</h3>
                    <ul id="recent-tracks"
                        class="display-6 text-center played-tracks list-unstyled d-flex flex-column gap-1 align-items-center">
                        <li><span id="played-tracks">&mdash;</span></li>
                    </ul>
            
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–í—ã–±–æ—Ä —Ç—Ä–µ–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) -->
            <div class="col-md-3">
                <div class="d-flex flex-column gap-3">
                    <div>
                        <!-- <h2>–í—ã–±–æ—Ä —Ç—Ä–µ–∫–∞</h2> -->
                        <label for="track-input">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:</label>
                        <input type="number" id="track-input" class="form-control" min="1" max="{{ music_lotto.playlist_files.count }}">
                        <button class="btn w-100 mt-2" onclick="playTrack()">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                    </div>

                    <div class="d-none">
                        <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
                        <p>–¢–µ–∫—É—â–∏–π —Ç—Ä–µ–∫: <span id="current-track">&mdash;</span></p>
                        <p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç—Ä–µ–∫–æ–≤: <span id="played-tracks">&mdash;</span></p>
                    </div>

                    <div class="bingo-tabs-container">
                        <ul class="nav nav-tabs" id="bingoTabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="one-tab" data-bs-toggle="tab" href="#one">One</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="triple-tab" data-bs-toggle="tab" href="#triple">Triple</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="full-tab" data-bs-toggle="tab" href="#full">Full</a>
                            </li>
                        </ul>
                    
                        <div class="tab-content bingo-scroll-container">
                            <div class="bingo-content tab-pane fade show active" id="one">
                                <p><span id="bingo-status"></span></p>
                            </div>
                            <div class="bingo-content tab-pane fade" id="triple">
                                <p><span id="triple-bingo-status"></span></p>
                            </div>
                            <div class="bingo-content tab-pane fade" id="full">
                                <p><span id="full-bingo-status"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- <div class="bingo-container">
                        <table class="table table-bordered text-center">
                            <thead>
                                <tr>
                                    <th class="fw-bold">one</th>
                                    <th class="fw-bold">triple</th>
                                    <th class="fw-bold">full</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><p><span id="bingo-status"></span></p></td>
                                    <td><p><span id="triple-bingo-status"></span></p></td>
                                    <td><p><span id="full-bingo-status"></span></p></td>
                                </tr>
                            </tbody>
                        </table>
                    </div> -->

                    <!-- <div>
                        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Bingo:</h2>
                        <p><span id="bingo-status"></span></p>
                        <p><span id="triple-bingo-status"></span></p>
                        <p><span id="full-bingo-status"></span></p>
                    </div> -->

                    <audio id="audio-player" controls class="w-100 d-none">
                        <source id="audio-source" src="" type="audio/mpeg">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç.
                    </audio>

                    <button class="btn w-100" onclick="clearSession()">–û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é</button>

                    <form target="_blank" method="post" action="{% url 'music_lotto_tracks' music_lotto.id %}">
                        {% csrf_token %}
                        <button type="submit" name="show_tracks" class="btn w-100">–í—ã–≤–æ–¥ —Ç—Ä–µ–∫–æ–≤</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const folderPath = "{{ folder_path|escapejs }}";  // –¢–µ–ø–µ—Ä—å –ø—É—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

        function playTrack() {
            const trackIdx = parseInt(document.getElementById('track-input').value, 10);
            if (isNaN(trackIdx) || trackIdx < 1) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç—Ä–µ–∫–∞.');
                return;
            }

            fetch("{% url 'play_track' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: `track_idx=${trackIdx - 1}&folder_path=${encodeURIComponent(folderPath)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(`–¢—Ä–µ–∫ –Ω–∞—á–Ω—ë—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...`);

                    setTimeout(() => {
                        document.getElementById('current-track').innerText = data.state.current_track;
                        const playedTracksContainer = document.getElementById('played-tracks');
                        playedTracksContainer.innerHTML = '';
                        data.state.played_tracks.slice(-10).forEach(track => {
                            const trackElement = document.createElement('span');
                            trackElement.textContent = track;
                            playedTracksContainer.appendChild(trackElement);
                            playedTracksContainer.appendChild(document.createElement('br'));
                        });

                        document.getElementById('bingo-status').innerText = data.state.bingo_info;
                        document.getElementById('triple-bingo-status').innerText = data.state.triple_bingo_info;
                        document.getElementById('full-bingo-status').innerText = data.state.full_bingo_info;

                        const audioPlayer = document.getElementById('audio-player');
                        const audioSource = document.getElementById('audio-source');
                        audioSource.src = data.track_url;
                        audioPlayer.load();
                        audioPlayer.play();

                        let removedTracks = JSON.parse(localStorage.getItem('removedTracks')) || [];
                        removedTracks.push(trackIdx);
                        localStorage.setItem('removedTracks', JSON.stringify(removedTracks));

                        notifyTracksPage();
                    }, 5000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ —Ç—Ä–µ–∫–∞.');
            });
        }

        function notifyTracksPage() {
            fetch("{% url 'get_tracks_state' music_lotto.id %}")
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem('updatedTracks', JSON.stringify(data));
                });
        }
    
        function clearSession() {
            fetch("{% url 'clear_session' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);

                // –û—á–∏—Å—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Ç—Ä–µ–∫–æ–≤
                localStorage.removeItem('removedTracks');  
                localStorage.removeItem('updatedTracks');  

                location.reload();
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–µ—Å—Å–∏–∏.");
            });
        }
    </script>

    <script>
        document.getElementById('track-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                playTrack(); // –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                this.value = ''; // –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏
            }
        });
    </script>

{% endblock %}
